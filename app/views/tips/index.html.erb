<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.0.0/jquery.min.js"></script>

<%= render 'nav' %>

<div align="center">
    <h1>Rick's Tips</h1>
</div>
<% subjects = @tips.select(:topic_id).distinct.where(approved: true).order(topic_id: :asc) %>
<% if subjects.length == 0 %>
    <h2 align="center">Sorry, we couldn't find any tips</h2>
<% else %>
    <% subjects.each do |subject| %>
        <div>
            <div class="tip-dropdown">
                <h2 id="first" class="tip-header">
                    <%= subject.topic.name %>
                    <div class="tip-dropdown-button"><i class="material-icons md-36">keyboard_arrow_right</i></div>
                </h2>
                <div class="tip-minimize-window">
                    <% subject_details = subjects.select(:subtopic_id).distinct.order(subtopic_id: :asc) %><!--.limit(10)-->
                    <% subject_details.each do |subject_detail| %>
                        <% if subject_detail.topic_id == subject.topic_id %>
                            <ul class="tip-detail-list">
                                <li>
                                    <h2 id="second" class="tip-header">
                                        <%= subject_detail.subtopic.name %>
                                        <div class="tip-dropdown-button"><i class="material-icons md-36">keyboard_arrow_right</i></div>
                                    </h2>
                                    <div class="tip-minimize-window">
                                        <% tips = @tips.where(approved: true).where(topic_id: subject.topic_id).where(subtopic_id: subject_detail.subtopic_id) %>
                                        <% tips.each do |tip| %>
                                            <ul class="tip-detail-list">
                                                <li>
                                                    <h2 id="third" class="tip-header">
                                                        <%= tip.title.split.map(&:capitalize)*' ' %>
                                                        <div class="tip-dropdown-button"><i class="material-icons md-36">keyboard_arrow_right</i></div>
                                                    </h2>
                                                    <ul class="tip-individual-list">
                                                        <li>
                                                            <%= tip.body %>
                                                        </li>
                                                    </ul>
                                                </li>
                                            </ul>
                                        <% end %>
                                    </div>
                                </li>
                            </ul>
                        <% end %>
                    <% end %>
                </div>
            </div>
        </div>
    <% end %>
<% end %>

<div id="tip-bottom"></div>

<div class="tip-blurb" align="center">
    <h1>What are Rick's Tips?</h1>
    <p>Rick's Tips are our own constantly evolving resource that is continuously being built by YOU the community</p>
</div>

<div align="center">
    <h1 style=" margin-bottom: 0">Submit your own tip!</h1>
</div>

<%= form_for @tip do |f| %>
    <%= f.label :title, "My Tip's Title" %>
    <%= f.text_field :title, placeholder: "Tip Title...", :required => true, maxlength: 50, id: "title" %>
    <div id="form" style="display: none;">
        <%= f.label :body, "My Tip"%>
        <%= f.text_area :body, placeholder: "Tip Body...", :required => true, maxlength: 500 %>
        <div class="field">
            <%= f.label :topic_id %>
            <%= f.collection_select :topic_id, Topic.order(:id), :id, :name, include_blank: false, include_blank: "Please select a topic" %>
        </div>
        <div class="field">
            <%= f.label :subtopic_id, "Subtopic" %>
            <%= f.grouped_collection_select :subtopic_id, Topic.order(:id), :subtopics, :name, :id, :name, :required => true, include_blank: true %>
        </div>
        <%= submit_tag "Submit" %>
    </div>
<% end %>

<script>
$(".tip-header").click(function(){
    if($(this.children[0]).html() == '<i class="material-icons md-36">keyboard_arrow_right</i>'){
        $(this.children[0]).html('<i class="material-icons md-36">keyboard_arrow_down</i>');
    }
    else{
        $(this.children[0]).html('<i class="material-icons md-36">keyboard_arrow_right</i>');
    }
    $(this.parentNode.children[1]).slideToggle();
});

$("#title").focus(function(){
    $("#form").slideDown();
});

jQuery(function() {
  var subtopics;
  $('#tip_subtopic_id').parent().hide();
  subtopics = $('#tip_subtopic_id').html();
  console.log(subtopics);
  return $('#tip_topic_id').change(function() {
    var topic, escaped_topic, options;
    topic = $('#tip_topic_id :selected').text();
    escaped_topic = topic.replace(/([ #;&,.+*~\':"!^$[\]()=>|\/@])/g, '\\$1');
    options = $(subtopics).filter("optgroup[label=" + escaped_topic + "]").html();
    console.log(options);
    if (options) {
      $('#tip_subtopic_id').html(options);
      return $('#tip_subtopic_id').parent().show();
    } else {
      $('#tip_subtopic_id').empty();
      return $('#tip_subtopic_id').parent().hide();
    }
  });
});
</script>
